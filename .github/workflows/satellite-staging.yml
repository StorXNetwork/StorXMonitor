name: Build Satellite on staging server

on:
  push:
    branches:
      - main    

env:
  GO_VERSION: '1.25.3'
  BIN_PATH: 'D:\bin'
  TEMP_PATH: 'D:\deployment'
  SERVICES: 'StorjSatellite'

jobs:
  build-satellite:
    runs-on: [self-hosted, windows, staging]
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        clean: true
      
    - name: Setup Go environment
      run: |
        # Check if Go is available
        $goCmd = Get-Command go -ErrorAction SilentlyContinue
        if (-not $goCmd) {
          Write-Error "Go is not installed. Please install Go ${{ env.GO_VERSION }} on the runner."
          exit 1
        }
        $goVersion = (go version 2>&1)
        Write-Host "Using installed Go: $goVersion"
        
        # Check if C compiler (gcc) is available for CGO
        $gccCmd = Get-Command gcc -ErrorAction SilentlyContinue
        if ($gccCmd) {
          Write-Host "C compiler (gcc) found: $($gccCmd.Source)"
          Write-Host "CGO will be enabled"
          [Environment]::SetEnvironmentVariable("CGO_ENABLED", "1", "Process")
          $env:CGO_ENABLED = "1"
        } else {
          Write-Host "C compiler (gcc) not found - CGO will be disabled"
          Write-Host "If CGO is required, please install MinGW-w64 or TDM-GCC"
          [Environment]::SetEnvironmentVariable("CGO_ENABLED", "0", "Process")
          $env:CGO_ENABLED = "0"
        }
      continue-on-error: false
        
    - name: Verify Go environment
      run: |
        go version
        go env GOROOT
        go env CGO_ENABLED
          
    - name: Pre-download dependencies
      run: |
        Write-Host "Pre-downloading dependencies..."
        go mod download
        if (Test-Path "cmd/satellite") {
          Write-Host "Pre-building satellite dependencies..."
          # Use a unique temp file to avoid file locking issues
          $tempExe = "$env:TEMP\satellite-prebuild-$([guid]::NewGuid()).exe"
          try {
            go build -o $tempExe ./cmd/satellite 2>&1 | Write-Host
            if (Test-Path $tempExe) {
              Remove-Item $tempExe -Force -ErrorAction SilentlyContinue
            }
            Write-Host "Pre-build completed successfully"
          } catch {
            Write-Host "Pre-build failed (non-critical): $_"
            Write-Host "Continuing with build..."
          }
        }
      continue-on-error: true
        
    - name: Build satellite.exe
      env:
        WEB3_AUTH_PRIVATE_KEY: ${{ secrets.WEB3_AUTH_PRIVATE_KEY }}
      run: |
        # Check if C compiler is available and set CGO_ENABLED accordingly
        $gccCmd = Get-Command gcc -ErrorAction SilentlyContinue
        if ($gccCmd) {
          $env:CGO_ENABLED = "1"
          Write-Host "C compiler found - Building with CGO_ENABLED=1"
        } else {
          $env:CGO_ENABLED = "0"
          Write-Host "C compiler not found - Building with CGO_ENABLED=0"
        }
        go build -ldflags "-s -w -X 'storj.io/storj/satellite/console/secretconstants.Web3AuthPrivateKey=$env:WEB3_AUTH_PRIVATE_KEY'" -o "$env:TEMP_PATH\satellite.exe" ./cmd/satellite
        
    - name: Quick service stop
      run: |
        Set-Location $env:BIN_PATH
        $status = (Get-Service -Name StorjSatellite -ErrorAction SilentlyContinue).Status
        if ($status -eq "Running" -or $status -eq "Paused" -or $status -eq "StartPending") {
          & ".\nssm.exe" stop StorjSatellite 2>&1 | Out-Null
          Start-Sleep -Seconds 2  # Reduced wait time
        }
        
    - name: Quick file replacement
      run: |
        # Minimal file operations
        if (Test-Path "$env:BIN_PATH\satellite.exe") {
          Remove-Item "$env:BIN_PATH\satellite.exe" -Force -ErrorAction SilentlyContinue
        }
        Move-Item "$env:TEMP_PATH\satellite.exe" "$env:BIN_PATH\satellite.exe" -Force
        Write-Host "satellite.exe replaced"
        
    - name: Quick service start
      run: |
        Set-Location $env:BIN_PATH
        
        # Check current service status
        $service = Get-Service -Name StorjSatellite -ErrorAction SilentlyContinue
        if ($service) {
          $status = $service.Status
          Write-Host "Current service status: $status"
          
          # Wait for service to be in a stable state if it's transitioning
          $maxWait = 15
          $waitCount = 0
          while (($status -eq "StartPending" -or $status -eq "StopPending" -or $status -eq "PausePending" -or $status -eq "ContinuePending") -and $waitCount -lt $maxWait) {
            Start-Sleep -Seconds 1
            $service.Refresh()
            $status = $service.Status
            Write-Host "Waiting for service to stabilize... Status: $status"
            $waitCount++
          }
          
          # Check status one more time right before attempting to start
          $service.Refresh()
          $status = $service.Status
          Write-Host "Service status before start attempt: $status"
          
          # Only start if service is stopped
          if ($status -eq "Stopped") {
            Write-Host "Starting service..."
            # Start service - capture output but don't fail on error (nssm may complain about StartPending)
            $ErrorActionPreference = "Continue"
            $startResult = & cmd /c ".\nssm.exe" start StorjSatellite 2>&1 | Out-String
            $exitCode = $LASTEXITCODE
            $ErrorActionPreference = "Stop"
            
            # Wait a moment for service state to update
            Start-Sleep -Seconds 2
            $service.Refresh()
            $finalStatus = $service.Status
            Write-Host "Service status after start attempt: $finalStatus"
            
            # Check if the error is about StartPending (which means service is actually starting)
            $isStartPendingError = $startResult -match "SERVICE_START_PENDING" -or $startResult -match "StartPending"
            
            # If service is starting/running OR we got StartPending error (which means it's starting), consider success
            if ($finalStatus -eq "Running" -or $finalStatus -eq "StartPending" -or $isStartPendingError) {
              if ($isStartPendingError) {
                Write-Host "nssm.exe reported StartPending error, but service is transitioning - this is expected"
              }
              Write-Host "Service start initiated successfully"
              # Wait for it to fully start
              $waitCount = 0
              while ($finalStatus -eq "StartPending" -and $waitCount -lt 30) {
                Start-Sleep -Seconds 1
                $service.Refresh()
                $finalStatus = $service.Status
                Write-Host "Waiting for service to start... Status: $finalStatus"
                $waitCount++
              }
              Write-Host "Final service status: $finalStatus"
              if ($finalStatus -eq "Running") {
                Write-Host "Service started successfully"
              } else {
                Write-Host "Warning: Service did not reach Running state. Final status: $finalStatus"
              }
            } elseif ($exitCode -ne 0) {
              Write-Host "nssm.exe returned exit code $exitCode"
              Write-Host "Output: $startResult"
              Write-Host "Warning: Service start may have failed. Current status: $finalStatus"
            }
          } elseif ($status -eq "Running") {
            Write-Host "Service is already running"
          } elseif ($status -eq "StartPending") {
            Write-Host "Service is already starting - waiting for it to complete"
            $waitCount = 0
            while ($status -eq "StartPending" -and $waitCount -lt 30) {
              Start-Sleep -Seconds 1
              $service.Refresh()
              $status = $service.Status
              Write-Host "Waiting for service to start... Status: $status"
              $waitCount++
            }
            Write-Host "Final service status: $status"
          } else {
            Write-Host "Service is in state: $status - attempting restart"
            & cmd /c ".\nssm.exe" stop StorjSatellite 2>&1 | Out-Null
            Start-Sleep -Seconds 5
            $service.Refresh()
            # Wait for stop to complete
            $stopWait = 0
            while ($service.Status -ne "Stopped" -and $stopWait -lt 15) {
              Start-Sleep -Seconds 1
              $service.Refresh()
              $stopWait++
            }
            if ($service.Status -eq "Stopped") {
              Write-Host "Service stopped, now starting..."
              $ErrorActionPreference = "Continue"
              $startResult = & cmd /c ".\nssm.exe" start StorjSatellite 2>&1 | Out-String
              $ErrorActionPreference = "Stop"
              Start-Sleep -Seconds 3
              $service.Refresh()
              Write-Host "Service status after restart: $($service.Status)"
            } else {
              Write-Host "Warning: Service did not stop properly. Status: $($service.Status)"
            }
          }
        } else {
          Write-Host "Service not found, attempting to start anyway"
          $ErrorActionPreference = "Continue"
          $startResult = & cmd /c ".\nssm.exe" start StorjSatellite 2>&1 | Out-String
          $ErrorActionPreference = "Stop"
          Start-Sleep -Seconds 2
          # Verify service exists and is starting/running
          $service = Get-Service -Name StorjSatellite -ErrorAction SilentlyContinue
          if ($service) {
            $service.Refresh()
            Write-Host "Service status: $($service.Status)"
          }
        }
        
        Write-Host "Service start completed"
