name: Build Storj Sim on staging server

on:
  push:
    branches:
      - main   
  workflow_dispatch:

env:
  BIN_PATH: 'D:\bin'
  TEMP_PATH: 'D:\deployment'

jobs:
  build-storj-sim:
    runs-on: [self-hosted, windows, staging]
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        clean: true
        
    - name: Build storj-sim.exe
      run: |
        go build -ldflags "-s -w" -o "$env:TEMP_PATH\storj-sim.exe" ./cmd/storj-sim
        
    - name: Quick service stop
      run: |
        Set-Location $env:BIN_PATH
        $status = (Get-Service -Name StorjSatellite -ErrorAction SilentlyContinue).Status
        if ($status -eq "Running" -or $status -eq "Paused" -or $status -eq "StartPending") {
          & ".\nssm.exe" stop StorjSatellite 2>&1 | Out-Null
          Start-Sleep -Seconds 2  # Reduced wait time
        }
        
    - name: Quick file replacement
      run: |
        # Minimal file operations
        if (Test-Path "$env:BIN_PATH\storj-sim.exe") {
          Remove-Item "$env:BIN_PATH\storj-sim.exe" -Force -ErrorAction SilentlyContinue
        }
        Move-Item "$env:TEMP_PATH\storj-sim.exe" "$env:BIN_PATH\storj-sim.exe" -Force
        Write-Host "storj-sim.exe replaced"
        
    - name: Quick service start
      run: |
        Set-Location $env:BIN_PATH
        $service = Get-Service -Name StorjSatellite -ErrorAction SilentlyContinue
        if (-not $service) {
          Write-Host "Service not found"
          exit 0
        }
        
        # Wait for service to stabilize if transitioning
        $maxWait = 10
        while ($maxWait -gt 0 -and ($service.Status -match "Pending")) {
          Start-Sleep -Seconds 1
          $service.Refresh()
          $maxWait--
        }
        
        if ($service.Status -eq "Stopped") {
          $ErrorActionPreference = "Continue"
          $result = & cmd /c ".\nssm.exe" start StorjSatellite 2>&1 | Out-String
          $ErrorActionPreference = "Stop"
          Start-Sleep -Seconds 3
          $service.Refresh()
          
          # Handle StartPending error (service is actually starting)
          if ($result -match "SERVICE_START_PENDING" -or $service.Status -eq "Running" -or $service.Status -eq "StartPending") {
            Write-Host "Service started successfully (Status: $($service.Status))"
            exit 0
          }
        } elseif ($service.Status -eq "Running") {
          Write-Host "Service already running"
          exit 0
        } else {
          Write-Host "Service in unexpected state: $($service.Status)"
        }