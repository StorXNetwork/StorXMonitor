name: Build Developer UI

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  TEMP_PATH: 'D:\deployment'
  DEPLOY_PATH: 'D:\StorjNetwork\developer-console-ui\build'
  UI_PATH: 'D:\StorXMonitor\satellite\developer\ui'

jobs:
  build-developer-ui:
    runs-on: [self-hosted, windows, staging]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.UI_PATH }}/package-lock.json
          
    - name: Install dependencies
      run: |
        echo "Installing npm dependencies..."
        cd ${{ env.UI_PATH }}
        npm ci
        echo "Dependencies installed successfully"
        
    - name: Build UI
      run: |
        buildStart=$(date +%s)
        echo "Building developer UI..."
        
        cd ${{ env.UI_PATH }}
        npm run build
        
        buildEnd=$(date +%s)
        buildTime=$((buildEnd - buildStart))
        echo "Build completed in ${buildTime} seconds"
        
        if [ -d "./build" ]; then
          buildSize=$(du -sh ./build | cut -f1)
          echo "Build folder created successfully (${buildSize})"
        else
          echo "Build failed - build folder not found"
          exit 1
        fi
        
    - name: Move build to deployment folder
      run: |
        echo "Moving build to deployment folder..."
        
        # Build folder is at ./satellite/developer/ui/build
        sourcePath="${{ env.UI_PATH }}/build"
        destPath="${{ env.TEMP_PATH }}/build"
        
        if [ ! -d "$sourcePath" ]; then
          echo "Build folder not found at $sourcePath"
          exit 1
        fi
        
        # Create temp directory if it doesn't exist
        mkdir -p "${{ env.TEMP_PATH }}"
        
        # Remove old build if exists
        if [ -d "$destPath" ]; then
          rm -rf "$destPath"
        fi
        
        # Move build to temp folder
        mv "$sourcePath" "$destPath"
        echo "Build moved to deployment folder: $destPath"
        
    - name: Deploy to Developer UI Build Path
      run: |
        echo "Deploying build to developer UI build path..."
        
        deploymentBuildPath="${{ env.TEMP_PATH }}/build"
        storjNetworkBuildPath="${{ env.DEPLOY_PATH }}"
        
        # Check if deployment build exists
        if [ ! -d "$deploymentBuildPath" ]; then
          echo "Deployment build not found at $deploymentBuildPath"
          exit 1
        fi
        
        # Ensure parent directory exists
        parentPath=$(dirname "$storjNetworkBuildPath")
        if [ ! -d "$parentPath" ]; then
          echo "Creating parent directory: $parentPath"
          mkdir -p "$parentPath"
        else
          echo "Parent directory exists: $parentPath"
        fi
        
        # Delete old build folder if it exists
        if [ -d "$storjNetworkBuildPath" ]; then
          echo "Build folder exists, deleting old build folder only..."
          rm -rf "$storjNetworkBuildPath"
          echo "Old build folder deleted"
        else
          echo "Build folder does not exist, will create new one"
        fi
        
        # Move build to final location
        echo "Moving build to $storjNetworkBuildPath..."
        mv "$deploymentBuildPath" "$storjNetworkBuildPath"
        echo "Build deployed successfully to $storjNetworkBuildPath"
        
        # Verify deployment
        if [ -d "$storjNetworkBuildPath" ]; then
          deployedSize=$(du -sh "$storjNetworkBuildPath" | cut -f1)
          echo "Deployment verified (${deployedSize})"
        else
          echo "Deployment verification failed"
          exit 1
        fi
        
    - name: Summary
      run: |
        echo ""
        echo "==============================================================="
        echo "[SUCCESS] Developer UI successfully built and deployed!"
        echo "Deployment Path: ${{ env.DEPLOY_PATH }}"
        echo "==============================================================="
        echo ""

