name: Build Developer UI

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  TEMP_PATH: 'D:\deployment'
  DEPLOY_PATH: 'D:\StorjNetwork\developer-console-ui\build'
  UI_PATH: 'D:\StorXMonitor\satellite\developer\ui'

jobs:
  build-developer-ui:
    runs-on: [self-hosted, windows, staging]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: satellite/developer/ui/package-lock.json
          
    - name: Install dependencies
      run: |
        Write-Host "Installing npm dependencies..."
        Set-Location $env:UI_PATH
        npm ci
        Write-Host "Dependencies installed successfully"
        
    - name: Build UI
      run: |
        $buildStart = Get-Date
        Write-Host "Building developer UI..."
        
        Set-Location $env:UI_PATH
        npm run build
        
        $buildTime = (Get-Date) - $buildStart
        Write-Host "Build completed in $($buildTime.TotalSeconds) seconds"
        
        if (Test-Path "./build") {
          $buildSize = (Get-ChildItem "./build" -Recurse | Measure-Object -Property Length -Sum).Sum
          Write-Host "Build folder created successfully ($([math]::Round($buildSize/1MB, 2)) MB)"
        } else {
          Write-Error "Build failed - build folder not found"
          exit 1
        }
        
    - name: Move build to deployment folder
      run: |
        Write-Host "Moving build to deployment folder..."
        
        # Build folder is at satellite/developer/ui/build
        $sourcePath = Join-Path $env:UI_PATH "build"
        $destPath = Join-Path $env:TEMP_PATH "build"
        
        if (-not (Test-Path $sourcePath)) {
          Write-Error "Build folder not found at $sourcePath"
          exit 1
        }
        
        # Create temp directory if it doesn't exist
        if (-not (Test-Path $env:TEMP_PATH)) {
          New-Item -ItemType Directory -Path $env:TEMP_PATH -Force | Out-Null
        }
        
        # Remove old build if exists
        if (Test-Path $destPath) {
          Remove-Item $destPath -Recurse -Force -ErrorAction SilentlyContinue
        }
        
        # Move build to temp folder
        Move-Item -Path $sourcePath -Destination $destPath -Force
        Write-Host "Build moved to deployment folder: $destPath"
        
    - name: Deploy to Developer UI Build Path
      run: |
        Write-Host "Deploying build to developer UI build path..."
        
        $deploymentBuildPath = Join-Path $env:TEMP_PATH "build"
        $storjNetworkBuildPath = $env:DEPLOY_PATH
        
        # Check if deployment build exists
        if (-not (Test-Path $deploymentBuildPath)) {
          Write-Error "Deployment build not found at $deploymentBuildPath"
          exit 1
        }
        
        # Ensure parent directory exists
        $parentPath = Split-Path $storjNetworkBuildPath -Parent
        if (-not (Test-Path $parentPath)) {
          Write-Host "Creating parent directory: $parentPath"
          New-Item -ItemType Directory -Path $parentPath -Force | Out-Null
        } else {
          Write-Host "Parent directory exists: $parentPath"
        }
        
        # Delete old build folder if it exists
        if (Test-Path $storjNetworkBuildPath) {
          Write-Host "Build folder exists, deleting old build folder only..."
          Remove-Item $storjNetworkBuildPath -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Old build folder deleted"
        } else {
          Write-Host "Build folder does not exist, will create new one"
        }
        
        # Move build to final location
        Write-Host "Moving build to $storjNetworkBuildPath..."
        Move-Item -Path $deploymentBuildPath -Destination $storjNetworkBuildPath -Force
        Write-Host "Build deployed successfully to $storjNetworkBuildPath"
        
        # Verify deployment
        if (Test-Path $storjNetworkBuildPath) {
          $deployedSize = (Get-ChildItem $storjNetworkBuildPath -Recurse | Measure-Object -Property Length -Sum).Sum
          Write-Host "Deployment verified ($([math]::Round($deployedSize/1MB, 2)) MB)"
        } else {
          Write-Error "Deployment verification failed"
          exit 1
        }
        
    - name: Summary
      run: |
        Write-Host ""
        Write-Host "===============================================================" -ForegroundColor Yellow
        Write-Host "[SUCCESS] Developer UI successfully built and deployed!" -ForegroundColor Yellow
        Write-Host "Deployment Path: $env:DEPLOY_PATH" -ForegroundColor Cyan
        Write-Host "===============================================================" -ForegroundColor Yellow
        Write-Host ""

